<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P5.js Sketch</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sorts+Mill+Goudy:wght@400;700&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.dom.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Sorts Mill Goudy', serif;
      letter-spacing: 1px;
      font-size: 11px;
      font-variation-settings: "wdth" 75;
    }
    #background {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background-color: #EFEFEF;
      z-index: 0;
    }
    #controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      border-radius: 15px;
      padding: 10px;
      font-family: 'JetBrains Mono', monospace;
      background-color: #EFEFEF; /* Asegura que el fondo del contenedor sea visible */
      width: calc(100% - 20px); /* Ajusta el ancho del contenedor */
      box-sizing: border-box;
    }
    #controls > * {
      margin-right: 10px; /* Espacio entre los elementos */
    }
    button, input[type="range"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border: none;
      margin: 5px;
    }
    button {
      background-color: black;
      color: white;
      padding: 10px 20px;
      font-size: 10px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: background-color 0.3s;
      border-radius: 30px;
    }
    button:hover {
      background-color: white;
      color: black;
    }
    input[type="range"] {
      width: 60px;
      height: 4px;
      background-color: black;
      cursor: pointer;
      padding: 0;
      margin: 5px;
      position: relative;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 100%;
      background: black;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      background: black;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-top: -7px;
      border: 2px solid black;
    }
    input[type="range"]::-moz-range-track {
      background: black;
      width: 100%;
      height: 100%;
    }
    input[type="range"]::-moz-range-thumb {
      background: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid black;
    }
    input[type="range"]::-ms-track {
      background: black;
      width: 100%;
      height: 100%;
      color: transparent;
    }
    input[type="range"]::-ms-thumb {
      background: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid black;
    }
    label {
      color: black;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }
    .info-text {
      margin-left: 10px;
      font-size: 11px;
      color: black;
      display: flex;
      align-items: center;
    }
    .logo-tools {
      width: 200px; /* Ajusta el tamaño del logo según sea necesario */
      height: auto;
      margin-left: auto; /* Empuja el logo hacia la derecha */
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <div id="controls">
    <button id="pasteButton">PEGAR</button>
    <button id="fontButton">CAMBIAR FUENTE</button>
    <button id="saveButton">GUARDAR IMÁGEN</button>
    <label for="spacingSlider">TAMAÑO-EFECTO</label>
    <input type="range" id="spacingSlider" min="1" max="25" value="1">
    <label for="cellSizeSlider">TAMAÑO-LETRAS</label>
    <input type="range" id="cellSizeSlider" min="10" max="50" value="50">
    <label for="cellWidthSlider">ESPACIADO</label>
    <input type="range" id="cellWidthSlider" min="10" max="25" value="17.5">
    <span class="info-text">PRESIONA "C" PARA CAMBIAR DE EFECTO</span>
    <img class="logo-tools" src="TOOLS.svg" alt="Logo">
  </div>
  <script>
    let inputText = ' hola, esto es una herramienta digital para el rastro®';
    let letters = [];
    let thickness = [];
    let cols, rows;
    let scl = 20;
    let cellWidth = 17.5;
    let mousePressedFlag = false;
    let currentFont;
    let resetPositions = false;
    let outlineMode = false;
    let spacing = 1;

    function setup() {
      createCanvas(windowWidth, windowHeight, P2D);
      currentFont = 'Sorts Mill Goudy'; // Fuente por defecto
      textFont(currentFont);
      textSize(scl);
      textAlign(CENTER, CENTER);

      select('#pasteButton').mousePressed(pasteTextFromClipboard);
      select('#fontButton').mousePressed(selectFont);
      select('#saveButton').mousePressed(saveImage);

      spacingSlider = select('#spacingSlider');
      cellSizeSlider = select('#cellSizeSlider');
      cellWidthSlider = select('#cellWidthSlider');

      spacingSlider.value(1);
      cellSizeSlider.value(50);
      cellWidthSlider.value(17.5);

      calculatePositions();
    }

    function draw() {
      background(255);
      fill(0);
      spacing = spacingSlider.value();
      let newScl = cellSizeSlider.value();
      cellWidth = cellWidthSlider.value();

      if (newScl !== scl || cellWidth !== cellWidth) {
        scl = newScl;
        textSize(scl);
        cols = Math.floor(width / cellWidth);
        rows = Math.floor(height / scl);
        letters = [];
        thickness = [];
        calculatePositions();
      }

      let textIndex = 0;
      for (let j = 0; j < rows; j++) {
        for (let i = 0; i < cols; i++) {
          if (textIndex < inputText.length) {
            let pos = letters[i][j];

            if (outlineMode && mousePressedFlag) {
              let d = dist(mouseX, mouseY, pos.x, pos.y);
              if (d < scl / 2) {
                thickness[i][j] += 0.1;
              }
            } else if (mousePressedFlag) {
              let d = dist(mouseX, mouseY, pos.x, pos.y);
              if (d < scl * spacing) {
                let angle = atan2(pos.y - mouseY, pos.x - mouseX);
                pos.x += cos(angle) * spacing;
                pos.y += sin(angle) * spacing;
              }
            } else if (resetPositions) {
              let target = createVector(i * cellWidth + cellWidth / 2, j * scl + scl / 2);
              pos.x = lerp(pos.x, target.x, 0.05);
              pos.y = lerp(pos.y, target.y, 0.05);
            }

            if (thickness[i][j] > 0) {
              for (let dx = -Math.ceil(thickness[i][j]); dx <= Math.ceil(thickness[i][j]); dx++) {
                for (let dy = -Math.ceil(thickness[i][j]); dy <= Math.ceil(thickness[i][j]); dy++) {
                  text(inputText.charAt(textIndex), pos.x + dx, pos.y + dy);
                }
              }
            }

            text(inputText.charAt(textIndex), pos.x, pos.y);
            textIndex++;
          }
        }
      }

      if (resetPositions && textIndex >= inputText.length) {
        resetPositions = false;
      }
    }

    function keyPressed() {
      if (keyCode === 67) { // 'C' key
        outlineMode = !outlineMode;
        resetPositions = true;
      } else if (keyCode === BACKSPACE && inputText.length > 0) {
        inputText = inputText.substring(0, inputText.length - 1);
        calculatePositions();
      } else if (keyCode !== SHIFT && keyCode !== CONTROL && keyCode !== ALT && keyCode !== 20) {
        inputText += key;
        calculatePositions();
      }
    }

    function calculatePositions() {
      let textIndex = 0;
      cols = Math.floor(width / cellWidth);
      rows = Math.floor(height / scl);
      letters = Array.from({ length: cols }, () => Array(rows).fill(null));
      thickness = Array.from({ length: cols }, () => Array(rows).fill(0));
      for (let j = 0; j < rows; j++) {
        for (let i = 0; i < cols; i++) {
          if (textIndex < inputText.length) {
            letters[i][j] = createVector(i * cellWidth + cellWidth / 2, j * scl + scl / 2);
            textIndex++;
          }
        }
      }
    }

    function pasteTextFromClipboard() {
      navigator.clipboard.readText().then((clipboardText) => {
        inputText = clipboardText.toLowerCase(); // Reemplazar el texto inicial
        calculatePositions();
      }).catch((err) => {
        console.error('Failed to read clipboard contents: ', err);
      });
    }

    function selectFont() {
      let input = createFileInput(handleFile);
      input.hide();
      input.elt.accept = '.ttf, .otf';
      input.elt.click();
    }

    function handleFile(file) {
      if (file.type === 'font') {
        loadFont(file.data, (font) => {
          currentFont = font;
          textFont(currentFont);
          calculatePositions();
        });
      }
    }

    function saveImage() {
      let scale = 5;
      let pg = createGraphics(width * scale, height * scale);
      pg.textFont(currentFont);
      pg.textSize(scl * scale);
      pg.textAlign(CENTER, CENTER);
      pg.background(255);
      pg.fill(0);

      let cols = Math.floor(pg.width / (cellWidth * scale));
      let rows = Math.floor(pg.height / (scl * scale));
      let textIndex = 0;
      let tempSpacing = spacing * scale;
      for (let j = 0; j < rows; j++) {
        for (let i = 0; i < cols; i++) {
          if (textIndex < inputText.length) {
            let pos = createVector(i * (cellWidth * scale) + (cellWidth * scale) / 2, j * (scl * scale) + (scl * scale) / 2);
            pg.text(inputText.charAt(textIndex), pos.x, pos.y);
            textIndex++;
          }
        }
      }

      save(pg, 'text_grid.png');
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      calculatePositions();
    }
  </script>
</body>
</html>
